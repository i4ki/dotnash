# cd alias add the branch name to prompt

# PROMPT is a special variable used by nash command line to
# setup your prompt.
PROMPTSYM = "Î»> "
DEFPROMPT = $NASH_RED+$PROMPTSYM+$NASH_RESET
PROMPT    = $DEFPROMPT

setenv PROMPT

fn refreshPrompt() {
	PROMPT = $DEFPROMPT
	IFS    = ""

	-test -d ./.git

	if $status == "0" {
		branch <= -git rev-parse --abbrev-ref HEAD >[2=]

		if $status == "0" {
			# workaround nash issue #96
			branch <= echo -n $branch | xargs echo -n

			PROMPT = $NASH_GREEN+"git:("+$branch+$NASH_RESET+")"+$DEFPROMPT
		}
	}

	setenv PROMPT
}

fn __docd(path) {
	chdir($path)
	refreshPrompt()
}

# cd overrides built-in cd
# Add the current branch before prompt (if current directory is a git
# repo)
fn cd(path) {
	IFS = ()

	if $path == "" {
		__docd($HOME)

		return
	}

	echo $path | -grep "^/"

	if $status != "0" {
		pwd <= pwd | tr -d "\n"

		newpath = $pwd+"/"+$path

		-test -d $newpath

		if $status == "0" {
			__docd($newpath)

			return
		}

		for prefix in $CDPATH {
			newpath = $prefix+"/"+$path

			-test -d $newpath

			if $status == "0" {
				__docd($newpath)

				return
			}
		}
	}

	path <= echo -n $path | sed "s#^~#"+$HOME+"#g" | tr -d "\n"

	__docd($path)
}

bindfn cd cd
